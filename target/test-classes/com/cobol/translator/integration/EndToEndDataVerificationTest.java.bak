package com.cobol.translator.integration;

import com.cobol.translator.parser.CobolASTParser;
import com.cobol.translator.generator.EntityGenerator;
import com.cobol.translator.data.CobolDataConverter;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.DisplayName;

import java.io.*;
import java.math.BigDecimal;
import java.nio.ByteBuffer;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.*;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Tests de vérification intégrité données bout-en-bout
 * Valide la conversion correcte des données COBOL → Java → COBOL
 */
@DisplayName("End-to-End Data Verification Tests")
public class EndToEndDataVerificationTest {

    private CobolASTParser parser;
    private EntityGenerator entityGenerator;
    private CobolDataConverter dataConverter;

    @BeforeEach
    public void setUp() {
        parser = new CobolASTParser();
        entityGenerator = new EntityGenerator();
        dataConverter = new CobolDataConverter();
    }

    @Test
    @DisplayName("Verify numeric data conversion COBOL to Java")
    public void testNumericDataConversion() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. NUMERIC-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-AMOUNTS.
                05  WS-INT          PIC 9(5) VALUE 12345.
                05  WS-DECIMAL      PIC 9(9)V99 VALUE 123456789.01.
                05  WS-SIGNED       PIC S9(5) VALUE -5000.
                05  WS-COMP         COMP PIC 9(9) VALUE 999999.
            """;

        var ast = parser.parseString(cobolCode, "NUMERIC-TEST");
        var entity = entityGenerator.generate(ast);

        assertNotNull(entity);
        
        // Verify generated Java classes have correct types
        assertTrue(entity.contains("Integer"), "Should have Integer field");
        assertTrue(entity.contains("BigDecimal"), "Should have BigDecimal for decimal fields");
        assertTrue(entity.contains("private Integer wsInt"), "INT field generated");
        assertTrue(entity.contains("private BigDecimal wsDecimal"), "DECIMAL field generated");
    }

    @Test
    @DisplayName("Verify string data conversion COBOL to Java")
    public void testStringDataConversion() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. STRING-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-STRINGS.
                05  WS-NAME         PIC X(30).
                05  WS-ADDRESS      PIC X(50).
                05  WS-CODE         PIC X(5).
                05  WS-DESCRIPTION  PIC X(100).
            """;

        var ast = parser.parseString(cobolCode, "STRING-TEST");
        var entity = entityGenerator.generate(ast);

        assertNotNull(entity);
        assertTrue(entity.contains("String wsName"), "String field for NAME");
        assertTrue(entity.contains("String wsAddress"), "String field for ADDRESS");
        assertTrue(entity.contains("String wsCode"), "String field for CODE");
    }

    @Test
    @DisplayName("Verify COMP-3 packed decimal conversion")
    public void testCOMP3DataConversion() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. COMP3-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-PACKED.
                05  WS-AMOUNT       COMP-3 PIC 9(9)V99 VALUE 123456789.01.
                05  WS-QUANTITY     COMP-3 PIC 9(5) VALUE 12345.
                05  WS-PRICE        COMP-3 PIC 9(7)V999 VALUE 1234567.890.
            """;

        var ast = parser.parseString(cobolCode, "COMP3-TEST");
        
        // COMP-3 should be converted to byte arrays or BigDecimal with special handling
        var entity = entityGenerator.generate(ast);
        assertNotNull(entity);

        // Verify COMP-3 fields are properly typed for binary operations
        assertTrue(entity.contains("wsAmount") || entity.contains("amount"));
    }

    @Test
    @DisplayName("Verify BINARY data type conversion")
    public void testBinaryDataConversion() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. BINARY-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-BINARY.
                05  WS-COUNT        BINARY PIC 9(5) VALUE 10000.
                05  WS-OFFSET       BINARY PIC 9(4) VALUE 256.
                05  WS-FLAGS        BINARY PIC X(2).
            """;

        var ast = parser.parseString(cobolCode, "BINARY-TEST");
        var entity = entityGenerator.generate(ast);

        assertNotNull(entity);
        // BINARY = COMP-4 or native binary
        assertTrue(entity.contains("Integer") || entity.contains("Long"));
    }

    @Test
    @DisplayName("Verify record group conversion with arrays")
    public void testRecordGroupConversion() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. RECORD-GROUP-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-CUSTOMER-GROUP.
                05  WS-CUST-ID      PIC 9(6).
                05  WS-CUST-NAME    PIC X(30).
                05  WS-CUST-ADDR    PIC X(50).
                05  WS-ACCOUNTS OCCURS 10 TIMES.
                    10  ACC-NUM     PIC 9(12).
                    10  ACC-BALANCE PIC 9(9)V99.
                    10  ACC-STATUS  PIC X.
            """;

        var ast = parser.parseString(cobolCode, "RECORD-GROUP-TEST");
        var entity = entityGenerator.generate(ast);

        assertNotNull(entity);
        assertTrue(entity.contains("List") || entity.contains("Array"), "OCCURS should generate List/Array");
        assertTrue(entity.contains("Account") || entity.contains("Accounts"), "Inner class for OCCURS");
    }

    @Test
    @DisplayName("Verify REDEFINES data integrity")
    public void testRedefinesDataIntegrity() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. REDEFINES-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-NUMERIC-FIELD   PIC 9(9).
            01  WS-ALPHA-VIEW REDEFINES WS-NUMERIC-FIELD PIC X(9).
            
            01  WS-PACKED-FIELD    COMP-3 PIC 9(9)V99.
            01  WS-BINARY-VIEW REDEFINES WS-PACKED-FIELD PIC 9(11).
            """;

        var ast = parser.parseString(cobolCode, "REDEFINES-TEST");
        
        // Verify REDEFINES creates union or alternative view
        assertNotNull(ast);
        var redefines = ast.getRedefinesFields();
        assertTrue(redefines.size() > 0, "Should detect REDEFINES relationships");
    }

    @Test
    @DisplayName("Verify data conversion round-trip COBOL → Java → COBOL")
    public void testRoundTripDataConversion() throws Exception {
        // Original COBOL data
        String originalData = "123456789.01";
        BigDecimal originalValue = new BigDecimal("123456789.01");

        // Convert to Java
        BigDecimal javaValue = originalValue;

        // Convert back to COBOL format (PIC 9(9)V99)
        String cobolValue = formatAsPIC99V99(javaValue);

        assertEquals("12345678901", cobolValue.replace(".", ""));
    }

    @Test
    @DisplayName("Verify file record structure conversion")
    public void testFileRecordStructureConversion() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. FILE-RECORD-TEST.
            
            DATA DIVISION.
            FILE SECTION.
            FD  CUSTOMER-FILE.
            01  CUSTOMER-RECORD.
                05  CUST-ID         PIC 9(6).
                05  CUST-NAME       PIC X(30).
                05  CUST-ADDRESS.
                    10  STREET      PIC X(30).
                    10  CITY        PIC X(20).
                    10  ZIP-CODE    PIC 9(5).
                05  CUST-BALANCE    PIC 9(9)V99.
                05  CUST-STATUS     PIC X.
                05  CUST-CREATED    PIC 9(8).
            """;

        var ast = parser.parseString(cobolCode, "FILE-RECORD-TEST");
        
        // Extract file definition
        var fileSection = ast.getFileSection();
        assertNotNull(fileSection);

        // Generate Java class for file record
        var entity = entityGenerator.generate(ast);
        assertNotNull(entity);

        // Verify nested structure conversion
        assertTrue(entity.contains("Address"), "Nested structure should be inner class");
        assertTrue(entity.contains("streetAddress"), "Nested field should be accessible");
    }

    @Test
    @DisplayName("Verify data type compatibility MOVE operations")
    public void testMoveDataTypeCompatibility() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. MOVE-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-INT          PIC 9(5) VALUE 123.
            01  WS-STR          PIC X(5).
            01  WS-DECIMAL      PIC 9(5)V99 VALUE 100.50.
            01  WS-CALC-RESULT  PIC 9(7)V999.
            
            PROCEDURE DIVISION.
            0000-MAIN.
                MOVE 12345 TO WS-INT.
                MOVE "HELLO" TO WS-STR.
                COMPUTE WS-CALC-RESULT = WS-INT * WS-DECIMAL.
                STOP RUN.
            """;

        var ast = parser.parseString(cobolCode, "MOVE-TEST");
        assertNotNull(ast);

        // Verify MOVE operations maintain type safety
        // MOVE 12345 TO PIC 9(5) - should truncate or validate range
        // MOVE "HELLO" TO PIC X(5) - should work
        // COMPUTE with DECIMAL - should maintain precision
    }

    @Test
    @DisplayName("Verify table/array data conversion")
    public void testTableDataConversion() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. TABLE-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-MONTHS OCCURS 12 TIMES.
                05  MONTH-NAME      PIC X(10).
                05  DAYS-IN-MONTH   PIC 9(2).
                05  SALES-AMOUNT    PIC 9(9)V99.
            
            01  WS-2D-TABLE.
                05  WS-ROW OCCURS 10 TIMES.
                    10  WS-COL OCCURS 10 TIMES.
                        15  CELL-VALUE PIC 9(5).
            """;

        var ast = parser.parseString(cobolCode, "TABLE-TEST");
        var entity = entityGenerator.generate(ast);

        assertNotNull(entity);
        // OCCURS should generate List<Month> with size constraints
        // 2D table should generate List<List<Cell>> or array[][]
    }

    @Test
    @DisplayName("Verify decimal precision preservation")
    public void testDecimalPrecisionPreservation() throws Exception {
        BigDecimal[] testValues = {
            new BigDecimal("0.99"),
            new BigDecimal("999999999.99"),
            new BigDecimal("1.01"),
            new BigDecimal("0.01"),
            new BigDecimal("-123456.78")
        };

        for (BigDecimal value : testValues) {
            // Test PIC 9(9)V99
            String formatted = formatAsPIC99V99(value);
            BigDecimal recovered = new BigDecimal(formatted.replace(".", "")).movePointLeft(2);
            
            assertEquals(value, recovered, "Precision lost for " + value);
        }
    }

    @Test
    @DisplayName("Verify signed numeric data integrity")
    public void testSignedNumericIntegrity() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. SIGNED-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-SIGNED-INT   PIC S9(5).
            01  WS-SIGNED-DEC   PIC S9(9)V99.
            01  WS-POSITIVE     PIC 9(5) VALUE 12345.
            01  WS-NEGATIVE     PIC S9(5) VALUE -12345.
            """;

        var ast = parser.parseString(cobolCode, "SIGNED-TEST");
        var entity = entityGenerator.generate(ast);

        assertNotNull(entity);
        // Signed fields should use Integer, not just digits
        // Check for proper sign handling
    }

    @Test
    @DisplayName("Verify FILLER fields handling")
    public void testFillerFieldsHandling() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. FILLER-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-RECORD.
                05  REC-ID       PIC 9(6).
                05  FILLER       PIC X(10).
                05  REC-NAME     PIC X(30).
                05  FILLER       PIC X(5).
                05  REC-AMOUNT   PIC 9(9)V99.
            """;

        var ast = parser.parseString(cobolCode, "FILLER-TEST");
        var entity = entityGenerator.generate(ast);

        assertNotNull(entity);
        // FILLER fields should either be ignored or included as padding
        assertFalse(entity.contains("filler"), "FILLER should not appear in Java class");
    }

    @Test
    @DisplayName("Verify data byte alignment and padding")
    public void testDataByteAlignment() throws Exception {
        // Test that record structures maintain correct byte boundaries
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. ALIGN-TEST.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-RECORD.
                05  FIELD-1      PIC 9(3).
                05  FIELD-2      PIC X(5).
                05  FIELD-3      PIC 9(2)V99.
            """;

        var ast = parser.parseString(cobolCode, "ALIGN-TEST");
        
        // Record should be: 3 bytes + 5 bytes + 4 bytes = 12 bytes total
        // Verify serialization maintains this structure
    }

    @Test
    @DisplayName("Verify FILE-CONTROL clause to Spring Batch ItemReader mapping")
    public void testFileControlToItemReaderMapping() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. FILE-IO-TEST.
            
            ENVIRONMENT DIVISION.
            INPUT-OUTPUT SECTION.
            FILE-CONTROL.
                SELECT INPUT-FILE
                    ASSIGN TO WS-INPUT-FILENAME
                    ORGANIZATION IS LINE SEQUENTIAL
                    FILE STATUS IS WS-FILE-STATUS.
                    
                SELECT OUTPUT-FILE
                    ASSIGN TO WS-OUTPUT-FILENAME
                    ORGANIZATION IS LINE SEQUENTIAL.
            
            DATA DIVISION.
            FILE SECTION.
            FD  INPUT-FILE.
            01  INPUT-RECORD    PIC X(100).
            
            FD  OUTPUT-FILE.
            01  OUTPUT-RECORD   PIC X(100).
            
            WORKING-STORAGE SECTION.
            01  WS-INPUT-FILENAME  PIC X(50).
            01  WS-OUTPUT-FILENAME PIC X(50).
            01  WS-FILE-STATUS     PIC X(2).
            """;

        var ast = parser.parseString(cobolCode, "FILE-IO-TEST");
        
        // Map FILE-CONTROL to Spring Batch ItemReader/Writer
        // SELECT ... ASSIGN TO → File path
        // ORGANIZATION → FlatFileItemReader vs FixedLengthItemReader
        // FILE STATUS → error handling
    }

    // ============ Helper Methods ============

    private String formatAsPIC99V99(BigDecimal value) {
        if (value == null) return "0.00";
        
        // Format as PIC 9(9)V99 = 9 digits + 2 decimal places
        String formatted = String.format("%011.2f", value).replace(".", "");
        
        if (formatted.length() > 11) {
            formatted = formatted.substring(formatted.length() - 11);
        } else if (formatted.length() < 11) {
            formatted = String.format("%011d", Long.parseLong(formatted));
        }
        
        // Insert decimal point at position 9 from right
        return formatted.substring(0, 9) + "." + formatted.substring(9);
    }

    private byte[] serializeCobolRecord(Object record) {
        // Serialize Java object back to COBOL binary format
        // Used for round-trip testing
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        // ... serialization logic
        return baos.toByteArray();
    }

    private Object deserializeCobolRecord(byte[] data, Class<?> recordClass) {
        // Deserialize COBOL binary data to Java object
        ByteArrayInputStream bais = new ByteArrayInputStream(data);
        // ... deserialization logic
        return null;
    }

    // Test data generators

    private static class TestDataGenerator {
        static String generateValidCobolRecord() {
            return "123456" +           // PIC 9(6)
                   "John Doe         " + // PIC X(30)
                   "123456789.01" +     // PIC 9(9)V99
                   "A";                  // PIC X
        }

        static String generateInvalidCobolRecord() {
            return "ABCDEF" +           // Invalid: should be numeric
                   "Jane Smith       " +
                   "999999999.99" +
                   "X";
        }
    }
}
