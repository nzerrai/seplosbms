package com.cobol.translator.semantic;

import com.cobol.translator.ast.DataItemNode;
import com.cobol.translator.ast.ProgramNode;
import com.cobol.translator.parser.CobolASTParser;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.nio.file.Paths;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Tests pour la Symbol Table - Registre des variables et paragraphes
 */
public class SymbolTableTest {

    private SymbolTable symbolTable;
    private CobolASTParser parser;

    @BeforeEach
    public void setUp() {
        symbolTable = new SymbolTable();
        parser = new CobolASTParser();
    }

    @Test
    public void testAddVariable() {
        // Ajouter une variable
        Symbol symbol = new Symbol(
            "WS-COUNTER",
            SymbolType.VARIABLE,
            "PIC 9(5)",
            "Integer",
            Scope.WORKING_STORAGE,
            1
        );

        symbolTable.addSymbol(symbol);

        // Vérifier qu'elle est trouvée
        Symbol retrieved = symbolTable.lookup("WS-COUNTER");
        assertNotNull(retrieved);
        assertEquals("Integer", retrieved.getJavaType());
    }

    @Test
    public void testUndefinedVariable() {
        // Chercher une variable non définie
        Symbol symbol = symbolTable.lookup("WS-UNDEFINED");
        assertNull(symbol);
    }

    @Test
    public void testDuplicate() {
        Symbol s1 = new Symbol("WS-NAME", SymbolType.VARIABLE, "PIC X(30)",
                               "String", Scope.WORKING_STORAGE, 1);
        symbolTable.addSymbol(s1);

        // Ajouter doublon → exception
        Symbol s2 = new Symbol("WS-NAME", SymbolType.VARIABLE, "PIC 9",
                               "Integer", Scope.WORKING_STORAGE, 5);
        
        assertThrows(DuplicateSymbolException.class, () -> {
            symbolTable.addSymbol(s2);
        });
    }

    @Test
    public void testGetJavaType() {
        symbolTable.addSymbol(new Symbol("WS-BALANCE", SymbolType.VARIABLE,
                                         "PIC 9(9)V99", "BigDecimal",
                                         Scope.WORKING_STORAGE, 1));

        String javaType = symbolTable.getJavaType("WS-BALANCE");
        assertEquals("BigDecimal", javaType);
    }

    @Test
    public void testBuildSymbolTableFromAST() {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. TEST-PROG.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-COUNTER      PIC 9(5).
            01  WS-NAME         PIC X(30).
            01  WS-BALANCE      PIC 9(9)V99.
            
            PROCEDURE DIVISION.
            0000-MAIN.
                PERFORM 100 TIMES
                    ADD 1 TO WS-COUNTER
                END-PERFORM.
            STOP RUN.
            """;

        ProgramNode ast = parser.parseString(cobolCode, "TEST-PROG");
        
        // Builder construit la symbol table
        SymbolTableBuilder builder = new SymbolTableBuilder();
        SymbolTable symTable = builder.buildSymbolTable(ast);

        // Vérifier que toutes les variables sont enregistrées
        assertTrue(symTable.isDefined("WS-COUNTER"));
        assertTrue(symTable.isDefined("WS-NAME"));
        assertTrue(symTable.isDefined("WS-BALANCE"));
        
        // Vérifier les types Java
        assertEquals("Integer", symTable.getJavaType("WS-COUNTER"));
        assertEquals("String", symTable.getJavaType("WS-NAME"));
        assertEquals("BigDecimal", symTable.getJavaType("WS-BALANCE"));
    }

    @Test
    public void testScopeAnalysis() {
        symbolTable.addSymbol(new Symbol("CUST-ID", SymbolType.VARIABLE,
                                         "PIC 9(6)", "Integer",
                                         Scope.FILE_SECTION, 1));
        
        symbolTable.addSymbol(new Symbol("WS-TEMP", SymbolType.VARIABLE,
                                         "PIC X(10)", "String",
                                         Scope.WORKING_STORAGE, 2));

        // Vérifier scopes différents
        Symbol custId = symbolTable.lookup("CUST-ID");
        Symbol wsTemp = symbolTable.lookup("WS-TEMP");
        
        assertEquals(Scope.FILE_SECTION, custId.getScope());
        assertEquals(Scope.WORKING_STORAGE, wsTemp.getScope());
    }

    @Test
    public void testParagraphRegistration() {
        // Enregistrer un paragraphe
        Symbol para = new Symbol("0000-MAIN", SymbolType.PARAGRAPH,
                                 null, null, Scope.PROCEDURE_DIVISION, 10);
        symbolTable.addSymbol(para);

        // Vérifier qu'on peut le trouver
        assertTrue(symbolTable.isDefined("0000-MAIN"));
        
        Symbol retrieved = symbolTable.lookup("0000-MAIN");
        assertEquals(SymbolType.PARAGRAPH, retrieved.getType());
    }

    @Test
    public void testFileRegistration() {
        // Enregistrer un fichier
        Symbol file = new Symbol("CUSTOMER-FILE", SymbolType.FILE,
                                 "FD", null, Scope.FILE_SECTION, 5);
        symbolTable.addSymbol(file);

        assertTrue(symbolTable.isDefined("CUSTOMER-FILE"));
        
        Symbol retrieved = symbolTable.lookup("CUSTOMER-FILE");
        assertEquals(SymbolType.FILE, retrieved.getType());
    }

    @Test
    public void testListAllVariables() {
        symbolTable.addSymbol(new Symbol("VAR1", SymbolType.VARIABLE, "PIC 9",
                                         "Integer", Scope.WORKING_STORAGE, 1));
        symbolTable.addSymbol(new Symbol("VAR2", SymbolType.VARIABLE, "PIC X",
                                         "String", Scope.WORKING_STORAGE, 2));

        var allVariables = symbolTable.getAllSymbols(SymbolType.VARIABLE);
        assertEquals(2, allVariables.size());
    }
}
