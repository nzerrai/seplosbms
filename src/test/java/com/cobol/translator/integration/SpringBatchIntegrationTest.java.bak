package com.cobol.translator.integration;

import com.cobol.translator.CobolTranslatorWebApplication;
import com.cobol.translator.service.CobolConversionService;
import com.cobol.translator.parser.CobolASTParser;
import com.cobol.translator.generator.EntityGenerator;
import com.cobol.translator.generator.JobConfigGenerator;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.autoconfigure.jdbc.AutoConfigureTestDatabase;
import org.springframework.batch.core.*;
import org.springframework.batch.test.JobLauncherTestUtils;
import org.springframework.batch.test.context.SpringBatchTest;
import org.springframework.test.context.ActiveProfiles;

import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Tests d'intégration Spring Batch end-to-end
 * Exécute un job complet avec reader, processor, writer
 */
@SpringBootTest(classes = CobolTranslatorWebApplication.class)
@SpringBatchTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.ANY)
@ActiveProfiles("test")
public class SpringBatchIntegrationTest {

    @Autowired
    private JobLauncherTestUtils jobLauncherTestUtils;

    @Autowired
    private CobolConversionService conversionService;

    private CobolASTParser parser;
    private Path tempDir;

    @BeforeEach
    public void setUp() throws Exception {
        parser = new CobolASTParser();
        tempDir = Files.createTempDirectory("cobol-test-");
    }

    @Test
    public void testSimpleJobExecution() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. SIMPLE-JOB.
            
            DATA DIVISION.
            WORKING-STORAGE SECTION.
            01  WS-COUNTER      PIC 9(5) VALUE 0.
            01  WS-TOTAL        PIC 9(7)V99 VALUE 0.
            
            PROCEDURE DIVISION.
            0000-MAIN.
                PERFORM 100 TIMES
                    ADD 1 TO WS-COUNTER
                    ADD 10.50 TO WS-TOTAL
                END-PERFORM.
                DISPLAY 'COUNTER: ' WS-COUNTER
                DISPLAY 'TOTAL: ' WS-TOTAL.
                STOP RUN.
            """;

        // Parser COBOL
        var ast = parser.parseString(cobolCode, "SIMPLE-JOB");
        
        // Générer code Spring Batch
        var jobConfig = new JobConfigGenerator()
            .generate(ast, "com.test.batch");
        
        assertNotNull(jobConfig);
        assertTrue(jobConfig.contains("@Configuration"));
        assertTrue(jobConfig.contains("@Bean"));
        assertTrue(jobConfig.contains("public Job"));
    }

    @Test
    public void testJobWithFileInput() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. FILE-READER.
            
            DATA DIVISION.
            FILE SECTION.
            FD  INPUT-FILE.
            01  INPUT-RECORD.
                05  REC-ID      PIC 9(6).
                05  REC-NAME    PIC X(30).
                05  REC-AMOUNT  PIC 9(9)V99.
            
            WORKING-STORAGE SECTION.
            01  WS-EOF          PIC X VALUE 'N'.
            01  WS-COUNTER      PIC 9(5) VALUE 0.
            
            PROCEDURE DIVISION.
            0000-MAIN.
                OPEN INPUT INPUT-FILE.
                PERFORM UNTIL WS-EOF = 'Y'
                    READ INPUT-FILE
                        AT END MOVE 'Y' TO WS-EOF
                        NOT AT END
                            ADD 1 TO WS-COUNTER
                            DISPLAY REC-ID ' ' REC-NAME ' ' REC-AMOUNT
                    END-READ
                END-PERFORM.
                CLOSE INPUT-FILE.
                STOP RUN.
            """;

        var ast = parser.parseString(cobolCode, "FILE-READER");
        
        // Générer Entity pour INPUT-RECORD
        var entity = new EntityGenerator().generate(ast);
        
        assertNotNull(entity);
        assertTrue(entity.contains("public class InputFileRecord"));
        assertTrue(entity.contains("private Integer recId"));
        assertTrue(entity.contains("private String recName"));
        assertTrue(entity.contains("private BigDecimal recAmount"));
    }

    @Test
    public void testJobWithDataValidation() throws Exception {
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. VALIDATE-DATA.
            
            DATA DIVISION.
            FILE SECTION.
            FD  CUSTOMER-FILE.
            01  CUSTOMER-RECORD.
                05  CUST-ID     PIC 9(6).
                05  CUST-NAME   PIC X(30).
                05  CUST-BALANCE PIC 9(9)V99.
            
            PROCEDURE DIVISION.
            0000-MAIN.
                OPEN INPUT CUSTOMER-FILE.
                PERFORM UNTIL 1 = 0
                    READ CUSTOMER-FILE
                        AT END GO TO 0999-END
                        NOT AT END
                            IF CUST-BALANCE > 0
                                DISPLAY 'VALID: ' CUST-ID
                            ELSE
                                DISPLAY 'INVALID: ' CUST-ID
                            END-IF
                    END-READ
                END-PERFORM.
                0999-END.
                CLOSE CUSTOMER-FILE.
                STOP RUN.
            """;

        var ast = parser.parseString(cobolCode, "VALIDATE-DATA");
        assertNotNull(ast);
        assertEquals("VALIDATE-DATA", ast.getProgramName());
    }

    @Test
    public void testComplexJobWithMultipleSteps() throws Exception {
        String jobCode = """
            //MYJOB JOB (ACCT),'BATCH PROCESS',CLASS=A
            //*
            //* STEP 1: Read input file
            //STEP1 EXEC PGM=CUSTREAD,PARM='INPUT'
            //STEPLIB DD DSN=LIB.LOADLIB,DISP=SHR
            //INPUT DD DSN=DATA.CUSTOMERS,DISP=SHR
            //OUTPUT DD DSN=TEMP.PROCESSED,DISP=(NEW,DELETE),
            // UNIT=SYSDA,SPACE=(TRK,(10,5))
            //*
            //* STEP 2: Validate data
            //STEP2 EXEC PGM=VALIDATE,PARM='CHECK'
            // COND=(0,NE,STEP1)
            //STEPLIB DD DSN=LIB.LOADLIB,DISP=SHR
            //INPUT DD DSN=TEMP.PROCESSED,DISP=SHR
            //VALID DD DSN=DATA.VALID,DISP=(NEW,CATLG)
            //INVALID DD DSN=DATA.INVALID,DISP=(NEW,CATLG)
            //*
            //* STEP 3: Create report
            //STEP3 EXEC PGM=REPORT,PARM='SUMMARY'
            // COND=((0,NE,STEP1),(0,NE,STEP2))
            //STEPLIB DD DSN=LIB.LOADLIB,DISP=SHR
            //VALID DD DSN=DATA.VALID,DISP=SHR
            //INVALID DD DSN=DATA.INVALID,DISP=SHR
            //REPORT DD DSN=DATA.REPORT,DISP=(NEW,CATLG)
            """;

        // JCL parsing would happen here
        // For now, just verify structure is understood
        assertTrue(jobCode.contains("STEP1"));
        assertTrue(jobCode.contains("STEP2"));
        assertTrue(jobCode.contains("STEP3"));
        assertTrue(jobCode.contains("COND="));
    }

    @Test
    public void testEndToEndConversion() throws Exception {
        // Créer un programme COBOL complet
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. CUSTOMER-BATCH.
            
            DATA DIVISION.
            FILE SECTION.
            FD  CUST-INPUT.
            01  CUST-IN-REC.
                05  CIN-ID      PIC 9(6).
                05  CIN-NAME    PIC X(30).
                05  CIN-BALANCE PIC 9(9)V99.
            
            FD  CUST-OUTPUT.
            01  CUST-OUT-REC.
                05  COUT-ID     PIC 9(6).
                05  COUT-NAME   PIC X(30).
                05  COUT-BALANCE PIC 9(9)V99.
                05  COUT-STATUS PIC X.
            
            WORKING-STORAGE SECTION.
            01  WS-EOF          PIC X VALUE 'N'.
            01  WS-REC-COUNT    PIC 9(9) VALUE 0.
            01  WS-MIN-BALANCE  PIC 9(9)V99 VALUE 1000.00.
            
            PROCEDURE DIVISION.
            0000-MAIN.
                OPEN INPUT CUST-INPUT.
                OPEN OUTPUT CUST-OUTPUT.
                
                PERFORM UNTIL WS-EOF = 'Y'
                    READ CUST-INPUT
                        AT END MOVE 'Y' TO WS-EOF
                        NOT AT END
                            PERFORM 1000-PROCESS-RECORD
                            ADD 1 TO WS-REC-COUNT
                    END-READ
                END-PERFORM.
                
                CLOSE CUST-INPUT.
                CLOSE CUST-OUTPUT.
                
                DISPLAY 'PROCESSED: ' WS-REC-COUNT.
                STOP RUN.
            
            1000-PROCESS-RECORD.
                MOVE FUNCTION UPPER-CASE(CIN-NAME) TO COUT-NAME.
                MOVE CIN-ID TO COUT-ID.
                MOVE CIN-BALANCE TO COUT-BALANCE.
                
                IF CIN-BALANCE >= WS-MIN-BALANCE
                    MOVE 'A' TO COUT-STATUS
                ELSE
                    MOVE 'I' TO COUT-STATUS
                END-IF.
                
                WRITE CUST-OUT-REC.
            """;

        // Step 1: Parse COBOL
        var ast = parser.parseString(cobolCode, "CUSTOMER-BATCH");
        assertNotNull(ast);

        // Step 2: Generate Entity
        var entityGen = new EntityGenerator();
        String inputEntity = entityGen.generateEntity(ast, "Input");
        String outputEntity = entityGen.generateEntity(ast, "Output");
        
        assertNotNull(inputEntity);
        assertNotNull(outputEntity);
        assertTrue(inputEntity.contains("class CustInRec"));
        assertTrue(outputEntity.contains("class CustOutRec"));

        // Step 3: Generate Job Config
        var jobGen = new JobConfigGenerator();
        String jobConfig = jobGen.generate(ast, "com.customer.batch");
        
        assertNotNull(jobConfig);
        assertTrue(jobConfig.contains("@Configuration"));
        assertTrue(jobConfig.contains("ItemReader"));
        assertTrue(jobConfig.contains("ItemProcessor"));
        assertTrue(jobConfig.contains("ItemWriter"));

        // Step 4: Generate Processor
        var procGen = new ProcessorGenerator();
        String processor = procGen.generate(ast);
        
        assertNotNull(processor);
        assertTrue(processor.contains("@Component"));
        assertTrue(processor.contains("ItemProcessor"));
        assertTrue(processor.contains("process"));
    }

    @Test
    public void testMultipleFileProcessing() throws Exception {
        // Test avec plusieurs fichiers d'entrée/sortie
        String cobolCode = """
            IDENTIFICATION DIVISION.
            PROGRAM-ID. MULTI-FILE-PROCESS.
            
            DATA DIVISION.
            FILE SECTION.
            FD  MASTER-FILE.
            01  MASTER-REC PIC X(100).
            
            FD  TRANSACTION-FILE.
            01  TRANS-REC PIC X(100).
            
            FD  OUTPUT-FILE.
            01  OUT-REC PIC X(100).
            
            PROCEDURE DIVISION.
            0000-MAIN.
                OPEN INPUT MASTER-FILE TRANSACTION-FILE.
                OPEN OUTPUT OUTPUT-FILE.
                PERFORM 1000-PROCESS.
                CLOSE MASTER-FILE TRANSACTION-FILE OUTPUT-FILE.
                STOP RUN.
            
            1000-PROCESS.
                READ MASTER-FILE.
                READ TRANSACTION-FILE.
                MOVE MASTER-REC TO OUT-REC.
                WRITE OUT-REC.
            """;

        var ast = parser.parseString(cobolCode, "MULTI-FILE-PROCESS");
        
        // Vérifier que tous les fichiers sont détectés
        var files = ast.getFiles();
        assertEquals(3, files.size());
    }
}
